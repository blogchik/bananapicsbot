name: CI/CD

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  lint:
    name: Lint Python
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff

      - name: Run ruff check
        run: ruff check bot/ api/

      - name: Run ruff format check
        run: ruff format --check bot/ api/

  lint-webapp:
    name: Lint & Build Webapp
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: webapp/package-lock.json

      - name: Install dependencies
        working-directory: webapp
        run: npm ci

      - name: TypeScript check
        working-directory: webapp
        run: npx tsc --noEmit

      - name: Build
        working-directory: webapp
        run: npm run build

  lint-admin-panel:
    name: Lint & Build Admin Panel
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: admin-panel/package-lock.json

      - name: Install dependencies
        working-directory: admin-panel
        run: npm ci

      - name: TypeScript check
        working-directory: admin-panel
        run: npx tsc --noEmit

      - name: Build
        working-directory: admin-panel
        run: npm run build

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: [lint, lint-webapp, lint-admin-panel]
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      postgres:
        image: postgres:16-alpine
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        options: >-
          --health-cmd "pg_isready -U test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
          cache-dependency-path: |
            api/requirements.txt
            api/requirements-test.txt

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r api/requirements.txt
          pip install -r api/requirements-test.txt

      - name: Run tests with coverage
        env:
          PYTHONPATH: api
          DATABASE_URL: postgresql+asyncpg://test:test@localhost:5432/test
          REDIS_URL: redis://localhost:6379/0
        run: |
          pytest api/tests -v --cov=api/app --cov-report=xml --cov-report=term-missing

      - name: Upload coverage to Codecov
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
        continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [lint, lint-webapp, lint-admin-panel]
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
        continue-on-error: true

  build-and-push:
    name: Build & Push Images
    needs: [test, security]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service: [api, bot, webapp, admin-panel]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository_owner }}/bananapicsbot/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,mode=max,scope=${{ matrix.service }}
          platforms: linux/amd64

  deploy:
    name: Deploy to Production
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://t.me/bananapicsbot

    steps:
      - uses: actions/checkout@v4

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: "placeholder"
          if_key_exists: replace

      - name: Add Known Hosts
        run: ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
          PROD_ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
        run: |
          # Retry function for SSH commands
          retry_ssh() {
            local max_attempts=3
            local timeout=30
            local attempt=1
            local exitCode=0

            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt of $max_attempts: $@"

              if eval "$@"; then
                echo "Command succeeded on attempt $attempt"
                return 0
              else
                exitCode=$?
                echo "Command failed with exit code $exitCode on attempt $attempt"

                if [ $attempt -lt $max_attempts ]; then
                  echo "Waiting $timeout seconds before retry..."
                  sleep $timeout
                fi
              fi

              attempt=$((attempt + 1))
            done

            echo "Command failed after $max_attempts attempts"
            return $exitCode
          }

          # Create short SHA for image tag (matches docker/metadata-action format)
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          IMAGE_TAG="sha-${SHORT_SHA}"

          # Create .env file from secret
          echo "$PROD_ENV_FILE" > .env.prod

          # Copy files to server with retry
          retry_ssh "scp .env.prod $SSH_USERNAME@$SSH_HOST:~/bananapicsbot/.env"
          retry_ssh "scp docker-compose.yml $SSH_USERNAME@$SSH_HOST:~/bananapicsbot/docker-compose.yml"

          # Deploy with specific image tag with retry
          retry_ssh "ssh $SSH_USERNAME@$SSH_HOST 'cd ~/bananapicsbot && \
            echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin && \
            export IMAGE_TAG=${IMAGE_TAG} && \
            docker compose pull api bot webapp admin-panel && \
            docker compose up -d --remove-orphans && \
            docker image prune -f'"

      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USERNAME: ${{ secrets.SSH_USERNAME }}
        run: |
          sleep 10
          ssh $SSH_USERNAME@$SSH_HOST "cd ~/bananapicsbot && docker compose ps"

      - name: Deployment summary
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** sha-${SHORT_SHA}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at:** $(date -u)" >> $GITHUB_STEP_SUMMARY
